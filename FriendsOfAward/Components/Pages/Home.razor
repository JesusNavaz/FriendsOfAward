@page "/vote/{token}"
@rendermode InteractiveServer

@using Microsoft.JSInterop
@inject NavigationManager MyNavMgr
@inject IJSRuntime JS

<button type="button" @onclick="Btn_GoToAdmin">Admin-Login</button>

<h1>Friends of Award</h1>
<p class="subtitle">Geben Sie uns Ihre persönlichen Favoriten bekannt!</p>

<p class="instructions">
    Einfacher Klick = Favorit ⭐ (max. 5)<br>
    Doppelklick = Superfavorit ⭐⭐ (max. 1)
</p>

<p class="instructions" style="font-size: 14px;">
    Diese Abstimmung ist anonym und auf ein Gerät beschränkt.
</p>

<div class="vote-grid">
    @for (int i = 1; i <= 20; i++)
    {
        <button type="button" class="vote-button" data-num="@i">
            @i
            <div class="star-container"></div>
        </button>
    }
</div>

<p class="status-text">
    Offen: <span id="favCount">0</span> Favoriten,
    <span id="topCount">0</span> Superfavorit
</p>

<button type="button" class="submit-btn" onclick="sendVotesToBlazor()">Bewertung absenden</button>

@code {
    public static Home Instance { get; private set; }

    [Parameter]
    public string? token { get; set; }

    public List<int> Favoriten = new();
    public int? Superfavorit = null;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Instance = this;
            await JS.InvokeVoidAsync("initVoteButtons");
        }
    }

    void Btn_GoToAdmin()
    {
        MyNavMgr.NavigateTo("/admin");
    }

    [JSInvokable]
    public static Task ReceiveVotes(List<int> favs, int? superFav)
    {
        Instance.Favoriten = favs;
        Instance.Superfavorit = superFav;

        Instance.SubmitVoting();
        Instance.MyNavMgr.NavigateTo($"/summary/{Instance.token}");

        return Task.CompletedTask;
    }

    public void SubmitVoting()
    {
        foreach (var fav in Favoriten)
        {
            string sql =
                $"INSERT INTO FoA_Voting_System (QrId, DaId) VALUES ('{token}', {fav})";
            DbWrapper.Wrapper.RunNonQuery(sql);
        }

        if (Superfavorit.HasValue)
        {
            string sql =
                $"INSERT INTO FoA_Voting_System (QrId, DaId) VALUES ('{token}', {Superfavorit.Value})";
            DbWrapper.Wrapper.RunNonQuery(sql);
        }
    }
}


<script>
    function initVoteButtons() {

        const buttons = document.querySelectorAll(".vote-button");
        let favCount = 0;
        let topCount = 0;
        let topFavoritButton = null;

        buttons.forEach(btn => {
            let clickTimeout = null;

            btn.addEventListener("click", () => {
                if (clickTimeout === null) {
                    clickTimeout = setTimeout(() => {
                        handleSingleClick(btn);
                        clickTimeout = null;
                    }, 200);
                }
            });

            btn.addEventListener("dblclick", () => {
                clearTimeout(clickTimeout);
                clickTimeout = null;
                handleDoubleClick(btn);
            });
        });

        function handleSingleClick(btn) {
            if (btn.classList.contains("topfavorit")) return;

            if (btn.classList.contains("favorit")) {
                btn.classList.remove("favorit");
                btn.querySelector(".star-container").innerHTML = "";
                favCount--;
            } else {
                if (favCount < 5) {
                    btn.classList.add("favorit");
                    btn.querySelector(".star-container").innerHTML =
                        "<i class='fa-solid fa-star'></i>";
                    favCount++;
                }
            }
            updateStatus();
        }

        function handleDoubleClick(btn) {
            if (btn.classList.contains("topfavorit")) {
                btn.classList.remove("topfavorit");
                btn.querySelector(".star-container").innerHTML = "";
                topCount = 0;
                topFavoritButton = null;
                updateStatus();
                return;
            }

            if (topFavoritButton) {
                topFavoritButton.classList.remove("topfavorit");
                topFavoritButton.querySelector(".star-container").innerHTML = "";
            }

            btn.classList.add("topfavorit");
            btn.querySelector(".star-container").innerHTML =
                "<i class='fa-solid fa-star'></i><i class='fa-solid fa-star'></i>";

            topFavoritButton = btn;
            topCount = 1;

            if (btn.classList.contains("favorit")) {
                btn.classList.remove("favorit");
                favCount--;
            }

            updateStatus();
        }

        function updateStatus() {
            document.getElementById("favCount").textContent = favCount;
            document.getElementById("topCount").textContent = topCount;
        }

        window.sendVotesToBlazor = function () {
            const favs = [];
            let superFav = null;

            document.querySelectorAll(".vote-button").forEach(btn => {
                const id = parseInt(btn.getAttribute("data-num"));

                if (btn.classList.contains("favorit"))
                    favs.push(id);

                if (btn.classList.contains("topfavorit"))
                    superFav = id;
            });

            DotNet.invokeMethodAsync("FriendsOfAward", "ReceiveVotes", favs, superFav);
        }
    }
</script>

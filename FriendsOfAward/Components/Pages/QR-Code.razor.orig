@page "/"
@using ClassLibrary
@rendermode InteractiveServer

<div class="page-background">
    <div class="qr-container">

        <h3>QR-Code</h3>

        <p class="small-note">
            Scanne den Code und vote für die beste Diplomarbeit
        </p>

        <button class="qr-button" @onclick="GenerateQrCode">
            QR-Code erzeugen
        </button>

        @if (!string.IsNullOrEmpty(QrCodeImage))
        {
            <img class="qr-image" src="@QrCodeImage" alt="QR-Code" />
        }

        @if (!string.IsNullOrEmpty(Message))
        {
            <span class="error">@Message</span>
        }

    </div>
</div>

@code {
    private string? QrCodeImage;
    private string? Message;


    private const string BaseUrl = "http://172.17.10.91:5432/vote/";

    private void GenerateQrCode()
    {
        try
        {
            // 1️⃣ Einmaliger Token
            string token = Guid.NewGuid().ToString();

            // 2️⃣ URL für Voting
            string payload = $"http://172.17.10.91:5432/vote/{token}";

            using var generator = new QRCoder.QRCodeGenerator();
            using var data = generator.CreateQrCode(payload, QRCoder.QRCodeGenerator.ECCLevel.Q);
            using var qrCode = new QRCoder.PngByteQRCode(data);

            byte[] qrBytes = qrCode.GetGraphic(20);
            QrCodeImage = $"data:image/png;base64,{Convert.ToBase64String(qrBytes)}";

            // In Datenbank speichern
            var qrCodeEntry = new QrCode(token.ToString().Substring(0, 8));
            QrCode.SaveQRtoDb(new List<QrCode> { qrCodeEntry });

            Message = null;
        }
        catch (Exception ex)
        {
            Message = $"Fehler beim Erzeugen des QR-Codes: {ex.Message}";
        }
    }
}

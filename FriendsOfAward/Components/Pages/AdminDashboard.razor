@page "/AdminDashboard"
@inject NavigationManager Navigation
@implements IDisposable

<AuthorizeView>
    <Authorized>
        <div class="admin-container topbar-layout">

            <header class="topbar">

                <div class="topbar-left">
                    <div class="topbar-title">ADMIN PANEL</div>
                </div>

                <div class="topbar-center">
                    <div class="voting-status-display @(votingActive ? "active" : "paused")">
                        <span class="status-icon">@(votingActive ? "▶️" : "")</span>
                        <div class="status-content">
                            <span class="status-text">@statusText</span>
                            <span class="status-time">@remainingTime</span>
                        </div>
                    </div>
                </div>

                <div class="topbar-right">
                    <div class="vote-actions">
                        <button type="button"
                                class="vote-icon-btn vote-start"
                                @onclick="Btn_StartVoting"
                                disabled="@votingActive"
                                title="Voting starten (10 Min)">
                            ▶
                        </button>

                        <button type="button"
                                class="vote-icon-btn vote-reset"
                                @onclick="Btn_ResetVoting"
                                title="Reset">
                            ⏹
                        </button>
                    </div>

                    <nav class="topbar-nav">
                        <button type="button" class="nav-btn active">Dashboard</button>

                        <button type="button"
                                class="nav-btn"
                                @onclick='() => Btn_NavigateTo("/QR-Code")'>
                            QR Codes
                        </button>

                        <button type="button"
                                class="nav-btn"
                                @onclick='() => Btn_NavigateTo("/Excel")'>
                            Excel
                        </button>
                    </nav>
                </div>

            </header>

            <main class="content">
                <h1 class="dashboard-title">Friends of Award Dashboard</h1>
                <p class="dashboard-subtitle">Live-Auswertung & Verwaltung der Abstimmung</p>

                <section class="score-cards">
                    @for (int i = 1; i <= 3; i++)
                    {
                        <div class="score-card">
                            <h2>#@i</h2>
                            <p class="project-name">Projektname</p>
                            <p class="score">0 <span class="points-label">Punkte</span></p>
                            <div class="stars">⭐ 0 | ⭐⭐ 0</div>
                        </div>
                    }
                </section>

                <section class="diploma-table-section">
                    <h2>Alle Diplomarbeiten</h2>
                    <table class="diploma-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Thema</th>
                                <th>Punkte</th>
                                <th>⭐⭐</th>
                                <th>⭐</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>Testprojekt</td>
                                <td>30</td>
                                <td>10</td>
                                <td>3</td>
                            </tr>
                        </tbody>
                    </table>
                </section>
            </main>

        </div>
    </Authorized>

    <NotAuthorized>
        <p>Nicht eingeloggt. <a href="/Admin">Zum Login</a></p>
    </NotAuthorized>
</AuthorizeView>

@code
{
    private bool votingActive = false;
    private string remainingTime = "10:00";
    private string statusText = "Kein aktuelles Voting";

    private System.Threading.Timer? timer;
    private DateTime endUtc;

    private void Btn_StartVoting()
    {
        if (votingActive)
            return;

        votingActive = true;
        statusText = "Voting läuft";
        endUtc = DateTime.UtcNow.AddMinutes(10);

        timer?.Dispose();
        timer = new System.Threading.Timer(_ =>
        {
            var diff = endUtc - DateTime.UtcNow;

            if (diff <= TimeSpan.Zero)
            {
                remainingTime = "00:00";
                votingActive = false;
                statusText = "Kein aktuelles Voting";

                timer?.Dispose();
                timer = null;

                _ = InvokeAsync(StateHasChanged);
                return;
            }

            int minutes = (int)diff.TotalMinutes;
            int seconds = diff.Seconds;
            remainingTime = $"{minutes:D2}:{seconds:D2}";

            _ = InvokeAsync(StateHasChanged);
        }, null, 0, 1000);

        StateHasChanged();
    }

    private void Btn_ResetVoting()
    {
        timer?.Dispose();
        timer = null;

        votingActive = false;
        remainingTime = "10:00";
        statusText = "Kein aktuelles Voting";

        StateHasChanged();
    }

    private void Btn_NavigateTo(string url) => Navigation.NavigateTo(url);

    public void Dispose() => timer?.Dispose();
}

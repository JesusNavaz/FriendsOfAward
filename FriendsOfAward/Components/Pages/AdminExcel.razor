@page "/admin/excel"
@rendermode InteractiveServer

@using ClassLibrary
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS

<h1>Admin: Excel Import/Export</h1>

@if (message != "")
{
    <p class="msg">@message</p>
}

<h3>Import Diplomarbeiten (ersetzt DB)</h3>

<p>
    <InputFile OnChange="OnFileSelected" accept=".xlsx" />
    <button class="btn" @onclick="Btn_ImportExcel" disabled="@(!canImport)">Import starten</button>
</p>

<h3>Export Auswertung</h3>

<p>
    <button class="btn" @onclick="Btn_ExportExcel">Excel herunterladen</button>
</p>

@code
{
    // MERKMALE
    private IBrowserFile? selectedFile = null;
    private string message = "";

    // PROPERTIES
    private bool canImport => selectedFile != null;

    // METHODEN
    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        message = $"Datei gewählt: {selectedFile.Name}";
    }

    private void Btn_ImportExcel()
    {
        message = "";

        if (selectedFile == null)
        {
            message = "Bitte zuerst eine Excel-Datei auswählen!";
            return;
        }

        try
        {
            using Stream stream = selectedFile.OpenReadStream(10 * 1024 * 1024);
            ExcelService.ImportDiplomaWorks(stream);
            message = "Import OK (DB ersetzt).";
        }
        catch (Exception ex)
        {
            message = $"Import-Fehler: {ex.Message}";
        }
    }

    private async Task Btn_ExportExcel()
    {
        message = "";

        try
        {
            byte[] bytes = ExcelService.ExportResultsToExcel();
            string base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("saveAsFile", "FoA_Auswertung.xlsx", base64);

            message = "Export OK (Download gestartet).";
        }
        catch (Exception ex)
        {
            message = $"Export-Fehler: {ex.Message}";
        }
    }
}

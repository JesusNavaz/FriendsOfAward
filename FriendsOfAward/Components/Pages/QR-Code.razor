@page "/"
@rendermode InteractiveServer

<div class="page-background">
    <div class="qr-container">

        <h3>QR-Code</h3>

        <p class="small-note">
            Scanne den Code und vote für die beste Diplomarbeit
        </p>

        <button class="qr-button" @onclick="GenerateQrCode">
            QR-Code erzeugen
        </button>

        @if (!string.IsNullOrEmpty(QrCodeImage))
        {
            <img class="qr-image" src="@QrCodeImage" alt="QR-Code" />
        }

        @if (!string.IsNullOrEmpty(Message))
        {
            <span class="error">@Message</span>
        }

    </div>
</div>

@code {
    private string? QrCodeImage;
    private string? Message;

    // Deine IP + Port aus launchSettings
    private const string BaseUrl = "http://172.17.7.62:5432/vote/";

    private void GenerateQrCode()
    {
        try
        {
            string token = Guid.NewGuid().ToString();

            // KEIN doppelter Slash
            string payload = $"{BaseUrl}{token}";

            using var generator = new QRCoder.QRCodeGenerator();
            using var data = generator.CreateQrCode(payload, QRCoder.QRCodeGenerator.ECCLevel.Q);
            using var qrCode = new QRCoder.PngByteQRCode(data);

            byte[] qrBytes = qrCode.GetGraphic(20);

            QrCodeImage = $"data:image/png;base64,{Convert.ToBase64String(qrBytes)}";
            Message = null;
        }
        catch (Exception ex)
        {
            Message = $"Fehler beim Erzeugen des QR-Codes: {ex.Message}";
        }
    }
}

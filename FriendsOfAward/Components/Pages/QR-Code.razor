@page "/"
@rendermode InteractiveServer

<div class="page-background">
    <div class="qr-container">
        <h3>QR-Code</h3>

        <p class="small-note">
            Scanne den Code und vote für die beste Diplomarbeit
        </p>

        <button class="qr-button" @onclick="GenerateQrCode">
            QR-Code erzeugen
        </button>

        @if (!string.IsNullOrEmpty(QrCodeImage))
        {
            <img class="qr-image" src="@QrCodeImage" alt="QR-Code" />
        }

        @if (!string.IsNullOrEmpty(Message))
        {
            <span class="error">@Message</span>
        }
    </div>
</div>

@code {
    private string? QrCodeImage;
    private string? Message;

    // später aus appsettings.json
    private const string BaseUrl = "http://intranet.htlvb.local/vote/";

    private void GenerateQrCode()
    {
        try
        {
            // 1️⃣ Einmaliger Token
            string token = Guid.NewGuid().ToString();

            // 2️⃣ URL für Voting
            string payload = $"{BaseUrl}{token}";

            // 3️⃣ QR-Code erzeugen
            using var generator = new QRCoder.QRCodeGenerator();
            using var data = generator.CreateQrCode(payload, QRCoder.QRCodeGenerator.ECCLevel.Q);
            using var qrCode = new QRCoder.PngByteQRCode(data);

            byte[] qrBytes = qrCode.GetGraphic(20);
            QrCodeImage = $"data:image/png;base64,{Convert.ToBase64String(qrBytes)}";

            Message = null;

            // 🔒 HIER SPÄTER:
            // Token + Status in DB speichern
        }
        catch (Exception ex)
        {
            Message = $"Fehler beim Erzeugen des QR-Codes: {ex.Message}";
        }
    }
}
